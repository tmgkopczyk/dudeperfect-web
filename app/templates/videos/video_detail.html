{% extends "base.html" %}
{% block title %}{{ video.title }}{% endblock %}

{% block content %}
<section class="space-y-6">

  <!-- Back link -->
  <button
    type="button"
    onclick="if (history.length > 1) history.back(); else window.location='/'"
    class="text-sm text-neutral-500 hover:text-[#2EFCE6]"
  >
    ‚Üê Back
  </button>

  <!-- Title -->
  <header class="space-y-1">
    <h1 class="text-3xl font-semibold text-neutral-900">
      {{ video.title }}
    </h1>

    {% if video.youtube_video_id %}
      <a
        href="https://www.youtube.com/watch?v={{ video.youtube_video_id }}"
        target="_blank"
        class="text-sm text-[#2EFCE6] hover:underline"
      >
        Watch on YouTube ‚Üí
      </a>
    {% endif %}
  </header>

  {% if battle %}

  <hr>

  <!-- Players -->
  <section class="space-y-3">
    <h3 class="text-lg font-medium text-neutral-900">
      Players
    </h3>

    <ul class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
      {% for team in battle.teams %}
        {% for player in team.players %}
          <li class="flex items-center gap-2 border rounded px-3 py-2 bg-white">
            {% if player.is_guest %}
              <span title="Guest">‚≠ê</span>
            {% endif %}
            {{ player.name }}
          </li>
        {% endfor %}
      {% endfor %}
    </ul>
  </section>

  {% if battle.description or battle.notes or battle.rules %}
  <hr>

  <!-- Battle Overview -->
  <section class="space-y-2">
    <h3 class="text-lg font-medium text-neutral-900">
      Battle Overview
    </h3>

    {% if battle.description %}
      <p class="text-sm text-neutral-700">
        {{ battle.description }}
      </p>
    {% endif %}

    {% if battle.rules %}
    <div class="text-sm text-neutral-700">
      <span class="font-semibold">Rules:</span>
        <div class="mt-1">
          {{ battle.rules }}
        </div>
    </div>
    {% endif %}


    {% if battle.notes %}
      <p class="text-sm text-neutral-600 italic">
        {{ battle.notes }}
      </p>
    {% endif %}
  </section>
  {% endif %}
  {% if battle.winner %}
  <div class="mt-4 flex items-center gap-2 rounded-lg border border-green-200 bg-green-50 px-4 py-3">
    <span class="text-lg">üèÜ</span>
    <span class="text-sm font-semibold text-green-700">
      Winner: {{ battle.winner }}
    </span>
  </div>
  {% endif %}


  {% if battle.timeline %}
  <hr>

  <section class="space-y-4">
    <h3 class="text-lg font-medium text-neutral-900">
      Battle Rounds
    </h3>

    {% for round in battle.timeline %}
      <div class="border rounded-lg p-4 space-y-3 bg-white">

        <div class="font-semibold text-neutral-800">
          {{ round.name }}
        </div>

        <ul class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
          {% for p in round.results %}
          <li class="flex flex-col border rounded px-2 py-1 bg-white">

            <!-- Name + status -->
            <div class="flex justify-between items-center">
              <span class="font-medium">{{ p.name }}</span>

              {% if p.status %}
                <span class="text-xs italic
                  {% if p.status == 'winner' %}text-green-700
                  {% elif p.status == 'runner_up' %}text-blue-600
                  {% else %}text-neutral-500
                  {% endif %}">
                  {{ p.status | replace('_',' ') | title }}
                </span>
              {% endif %}
            </div>

            <!-- Score -->
            {% if p.score is defined and p.score is not none %}
              <div class="text-xs text-neutral-600">
                {{ p.score|round(2) }}
                {% if round.score_label %} {{ round.score_label }}{% endif %}
              </div>
            {% endif %}

            <!-- Notes -->
            {% if p.notes %}
              <div class="text-xs text-neutral-500 italic">
                {{ p.notes }}
              </div>
            {% endif %}

          </li>
          {% endfor %}

        </ul>

      </div>
    {% endfor %}
  </section>
  {% endif %}


  {% endif %}

  {% if overtime and overtime.segments %}
  <hr>

  <section class="space-y-6">

    <h2 class="text-xl font-semibold text-neutral-900">
      Overtime Segments
    </h2>

    {% for segment in overtime.segments %}

      <!-- ================= COOL NOT COOL ================= -->
      {% if segment.segment_type == "Cool Not Cool" %}
      <div class="border rounded-lg p-4 bg-white space-y-4">
        <div class="font-semibold text-lg">Cool Not Cool</div>

        {% for item in segment.items %}
          <div class="border rounded p-3 space-y-2">
            <div class="flex justify-between">
              <span class="font-medium">
                {{ item.presenter_name }} ‚Äî {{ item.item_name }}
              </span>

              {% if item.overall %}
                <span class="
                  {% if item.overall == 'cool' %}
                    text-green-600
                  {% elif item.overall == 'not_cool' %}
                    text-red-600
                  {% else %}
                    text-blue-600
                  {% endif %}
                ">
                  {{ item.overall | replace('_',' ') | title }}
                </span>
              {% endif %}
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
              {% for vote in item.votes %}
                <div class="flex justify-between border rounded px-2 py-1">
                  <span>{{ vote.voter_name }}</span>
                  <span>{{ vote.vote | replace('_',' ') | title }}</span>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- ================= WHEEL ================= -->
      {% if segment.segment_type in ["Wheel Unfortunate","Wheel Fortunate"] %}
      <div class="border rounded-lg p-4 bg-white space-y-2">
        <div class="font-semibold text-lg">
          üé° {{ segment.segment_type }}
        </div>

        {% if segment.event %}
          <div><strong>Selected:</strong> {{ segment.event.selected_player }}</div>
          {% if segment.event.host_name %}
            <div><strong>Host:</strong> {{ segment.event.host_name }}</div>
          {% endif %}
          <div><strong>Mechanism:</strong> {{ segment.event.mechanism }}</div>
          <div>
            <strong>{{ segment.event.outcome_type | title }}:</strong>
            {{ segment.event.outcome_text }}
          </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- ================= BETCHA ================= -->
      {% if segment.segment_type == "Betcha" %}
      <div class="border rounded-lg p-4 bg-white space-y-3">
        <div class="font-semibold text-lg">Betcha</div>

        {% if segment.event %}
          <div><strong>Presenter:</strong> {{ segment.event.presenter_name }}</div>
          <div>{{ segment.event.bet_description }}</div>
        {% endif %}

        <div class="grid grid-cols-2 gap-2 text-sm">
          {% for vote in segment.votes %}
            <div class="flex justify-between border rounded px-2 py-1">
              <span>{{ vote.voter_name }}</span>
              <span>{{ vote.vote | title }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- ================= GET CRAFTY ================= -->
      {% if segment.segment_type == "Get Crafty" %}
      <div class="border rounded-lg p-4 bg-white space-y-3">
        <div class="font-semibold text-lg">Get Crafty</div>

        {% for entry in segment.entries %}
          <div class="border rounded p-2">
            <div class="flex justify-between">
              <span>{{ entry.name }}</span>
              {% if entry.is_winner %}
                <span class="text-green-600 font-semibold">Winner</span>
              {% endif %}
            </div>
            <div class="text-sm text-neutral-600">
              {{ entry.entry_description }}
            </div>
          </div>
        {% endfor %}
      </div>
      {% endif %}

    {% endfor %}
  </section>
  {% endif %}



  <hr class="border-neutral-300">

  <!-- Songs section -->
  <section class="space-y-3">
    <h2 class="text-xl font-medium text-neutral-900">
      Songs used
    </h2>

    {% if video.songs %}
      <ul class="space-y-3">
        {% for song in video.songs %}
          <li class="border border-gray-200 rounded p-3 hover:bg-gray-50">
            <a
              href="/songs/{{ song.id }}"
              class="font-semibold hover:text-[#2EFCE6]"
            >
              {{ song.title }}
            </a>

            {% if song.artists %}
              <div class="text-sm text-neutral-600">
                {{ song.artists | join(', ') }}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-neutral-600 italic">
        No songs currently linked to this video.
      </p>
    {% endif %}
  </section>

</section>
{% endblock %}
